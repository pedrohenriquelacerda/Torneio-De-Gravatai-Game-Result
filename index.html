<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resultados por Número do Jogo</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container my-5">
      <h1 class="text-center mb-4">Resultados por Número do Jogo</h1>
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="input-group mb-3">
            <input
              type="number"
              id="numeroDoJogo"
              class="form-control"
              placeholder="Digite o número do jogo"
              disabled
            />
            <button
              onclick="buscarJogo()"
              id="buscarButton"
              class="btn btn-primary"
              disabled
            >
              Buscar
            </button>
          </div>
        </div>
      </div>
      <div id="output" class="row"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const sheetId = "18XYOWmxugoRUxaat6rkYdCmM2B3l5RUpdlMOf6gY2hM";
      const sheetName = encodeURIComponent("Respostas ao formulário 1");
      const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;
      var isFetched = false;

      let sheetObjects = []; // Armazenará os objetos após carregar do Google Sheets

      fetch(sheetURL)
        .then((response) => response.text())
        .then((csvText) => {
          sheetObjects = csvToObjects(csvText);
          console.log(sheetObjects);
          isFetched = true; // Confirme os dados no console
          enableInputs();
        });

      function enableInputs() {
        document.getElementById("numeroDoJogo").disabled = false;
        document.getElementById("buscarButton").disabled = false;
      }

      function csvToObjects(csv) {
        const csvRows = csv.split("\n");
        const propertyNames = csvSplit(csvRows[0]);
        let objects = [];
        for (let i = 1, max = csvRows.length; i < max; i++) {
          let thisObject = {};
          let row = csvSplit(csvRows[i]);
          for (let j = 0, max = row.length; j < max; j++) {
            thisObject[propertyNames[j]] = row[j];
          }
          objects.push(thisObject);
        }
        return objects;
      }

      function csvSplit(row) {
        return row.split(",").map((val) => val.substring(1, val.length - 1));
      }

      function buscarJogo() {
        if (!isFetched) {
          alert(
            "Os dados ainda não foram carregados. Por favor, tente novamente."
          );
          return;
        }

        const numeroDoJogo = document.getElementById("numeroDoJogo").value;
        const resultados = sheetObjects.filter(
          (item) => item["Número do jogo "] === numeroDoJogo.toString()
        );

        // Exibir resultados no HTML
        const outputDiv = document.getElementById("output");
        outputDiv.innerHTML = "";

        if (resultados.length === 0) {
          outputDiv.innerHTML = `
            <div class="col-12">
              <div class="alert alert-warning text-center">
                Nenhum resultado encontrado para o número do jogo ${numeroDoJogo}
              </div>
            </div>`;
          return;
        }

        var pontosTotais = 0;

        resultados.forEach((objeto) => {
          const card = document.createElement("div");
          pontosTotais =
            parseInt(objeto["Resíduos Movimentados (Soma dos pontos) "]) +
            parseInt(objeto["Resíduos Zona de Carga (Soma dos pontos) "]) +
            parseInt(objeto["Resíduos Reciclados (Soma dos pontos) "]) +
            parseInt(objeto["Estacionado (Global - Soma dos pontos) "]) +
            parseInt(
              objeto["Resíduos Reciclados (Global - Soma dos pontos) "]
            ) +
            parseInt(
              objeto["Todos Resíduos Reciclados  (Global - Soma dos pontos) "]
            );

          card.className = "col-md-4";
          card.innerHTML = `
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h5 class="card-title">Equipe: ${objeto["Equipe "]}</h5>
              <p class="card-text"><strong>Resíduos Movimentados:</strong> ${objeto["Resíduos Movimentados (Soma dos pontos) "]}</p>
              <p class="card-text"><strong>Resíduos Zona de Carga:</strong> ${objeto["Resíduos Zona de Carga (Soma dos pontos) "]}</p>
              <p class="card-text"><strong>Resíduos Reciclados:</strong> ${objeto["Resíduos Reciclados (Soma dos pontos) "]}</p>
              <p class="card-text"><strong>Estacionado:</strong> ${objeto["Estacionado (Global - Soma dos pontos) "]}</p>
              <p class="card-text"><strong>Resíduos Reciclados COOP:</strong> ${objeto["Resíduos Reciclados (Global - Soma dos pontos) "]}</p>
              <p class="card-text"><strong>Todos Resíduos Reciclados COOP:</strong> ${objeto["Todos Resíduos Reciclados  (Global - Soma dos pontos) "]}</p>
              <p class="card-text"><strong>Reciclagem Perfeita COOP:</strong> ${objeto["Reciclagem Perfeita (Global - Soma dos pontos) "]}</p>
              <p class="card-text"><strong>Tempo da Partida:</strong> ${objeto["Tempo da partida (segundos) "]} segundos</p>
              <p class="card-text"><strong>Pontos Totais:</strong> ${pontosTotais}</p>
            </div>
          </div>`;
          outputDiv.appendChild(card);
        });
      }
    </script>
  </body>
</html>
